# VM

VM -- это просто набор скриптов для самого себя, которые можно использовать
для автоматизации запуска и развёртывания виртуальных машин, просто обёртка
над командной строкой qemu.

## Системные требования

- Исполняемый файл `qemu-system-*` для вашей аппаратной платформы.
- Исполняемый файл `qemu-img` для создания пустых виртуальных дисков.
- Файлы OVMF BIOS для поддержки режима загрузки UEFI внутри гостевых ВМ.
- Исполняемые файлы `pigz` и `unpigz` для работы со снимками виртуальных машин.
- Исполняемый файл `remote-viewer` (необязателен) для работы с гостевыми ВМ.
- `bash` на хосте и `sh` внутри ВМ с ALT Rescue для выполнения заданий.

## Возможности

- Создание, сохранение, восстановление и уничтожение виртуальных машин.
- Много полезных умолчаний для ваших ВМ уже имеется "из коробки".
- Выполнение заданий-скриптов внутри ВМ с перепакованной ALT Rescue.
- Использование разных цветов в консоли и возможность подстраивать цвета.
- Необязательное использование внешнего носителя для хранения объёмных данных.
- Запуск гостевой ВМ на локальном хосте с графическим видеоадаптером.
- Запуск на удалённом сервере. Протокол SPICE доступен в любом случае.
- Создание рабочих файлов на месте и в каталоге `$TMPDIR` (по умолчанию).

## Подготовка рабочего пространства

- Скопируйте скрипты из `bin` в ваш каталог с исполняемыми файлами, дайте
  им права на выполнение. Можете внести изменения в них, при необходимости.
- Создайте под-каталог `vm` в вашем домашнем каталоге и скопируйте в него
  под-каталог `scripts`.
- Подготовьте специальный ISO-образ ALT Rescue для выполнения в нём заданий.
- Добавьте следующие строки в ваш `~/.ssh/config`:

```
Host    kvm
        Hostname 127.0.0.1
        NoHostAuthenticationForLocalhost yes
        IdentityFile ~/.ssh/id_ed25519
        Port 5555
        User root
```

## Подготовка специального ISO-образа ALT Rescue

Примерный план действий:

```bash
$ mkdir -p -m 755 ~/tmp/stage3 ~/vm/rescue-x86_64
$ cd ~/vm/rescue-x86_64/
$ wget http://nightly.altlinux.org/p10/permalink/alt-p10-rescue-latest-x86_64.iso
$ cp -Lf ~/vm/scripts/rescue-stage3 ~/tmp/stage3/autorun
$ alt2deploy -r ~/tmp/stage3 alt-p10-rescue-latest-x86_64.iso rescue-p10-x86_64.iso
$ rm -rf ~/tmp/stage3 alt-p10-rescue-latest-x86_64.iso
$ cat >guest.env <<EOF
RESCUE_CORES=4
RESCUE_MEMORY="2G"
RESCUE_ISO="rescue-p10-x86_64.iso"
RESCUE_FORWARDS="hostfwd=tcp::5555-:22"
EOF
```

## Конфигурация и изменение значений по умолчанию

- `/etc/vm.conf` - глобальные параметры для всех пользователей,
  они перезаписывают значения по умолчанию.
- `~/.config/vm.conf` - персональные параметры пользователя, они
  перезаписывают ещё и глобальные параметры для всех пользователей.
- `vm.defaults` - дополнительные аргументы для qemu: такой файл можно
  сложить в каталоги `/etc`, `~/.config`, `$HOSTDIR` или `$WORKDIR`
  (см. `vm-cmd-run.sh` для получения подробностей).

### Сценарий check-media

Включаемый сценарий `check-media` должен установить переменную `$MEDIA` и,
при необходимости, убедиться в доступности подключенного внешнего носителя.

### Пример ~/.config/vm.conf:

```
MEMORY=4G
MEDIA_MIRROR="/alt-mirror"
MEDIA_STORAGE="/images/iso"
FORWARDS="hostfwd=tcp::5555-:22"
SSHKEYS=( "$HOME/.ssh/id_ed25519.pub" )
```

Где:

- `$MEDIA_MIRROR` - Каталог зеркала репозиториев относительно `$MEDIA`.
- `$MEDIA_STORAGE` - Каталог ISO-образов относительно `$MEDIA`.
- `$SSHKEYS` (массив) - Список путей к публичным ключам SSH, используемым
  в некоторых сценариях.

## Создание снимков

Вы можете делать столько снимков ВМ, сколько необходимо. Каждому снимку
может быть дано произвольное название. К снимку можно добавить краткое
описание. По умолчанию снимки автоматически именуются как `S0`, `S1`,
`S2` и т.д. Символическая ссылка `LAST` указывает на самый последний
сделанный снимок.

## Восстановление из снимка

Команда `vm restore` позволяет восстановить рабочее состояние виртуальной
машины из последнего снимка. Для восстановления из другого снимка необходимо
указать его название, например: `vm restore 2023-05-10`. Если при запуске
ВМ рабочих файлов не окажется, автоматически запустится восстановление из
последнего сделанного снимка.

## Задания

Задание -- это произвольный набор файлов, один, два или три скрипта, из
которых обязателен только скрипт `.job`. Сценарии заданий могут находиться
в двух местах: в каталоге ВМ и в общем месте их хранения: `$LIBEXEC/jobs`.
Остальные файлы для гостевой ВМ могут находиться где угодно.

Обычно скрипт `.pre` копирует всё необходимое в `$WORKDIR/.in/`, туда же
копируется и скрипт `.job`. После завершения задания и выключения ВМ будет
запущен скрипт `.post`, если он имеется.

Внутри ВМ с ALT Rescue можно использовать следуюшие точки монтирования:

- `/tmp/.mirror` (опционально, только чтение) - зеркало репозиториев.
- `/tmp/.in` (только чтение) - для чтения исходных данных этого задания.
- `/tmp/.out` (полный доступ) - для сохранения результатов задания и логов.

В скриптах `<JOBNAME>.pre` и `<JOBNAME>.post` можно использовать все
переменные, объявленные в `vm-main.sh`. Наиболее полезными являются:

- `$HOSTDIR` - основной каталог с параметрами и снимками ВМ.
- `$WORKDIR` - временный каталог с рабочими файлами ВМ. Он может полностью
  совпадать с `$HOSTDIR` только при запуске программы с опцией `--inplace`,
  но по умолчанию рабочие файлы создаются на runfs или tmpfs (в `$TMPDIR`).
- `$LIBEXEC` - каталог со скриптами этой утилиты, такими как `vm-main.sh`.

Скрипт `<JOBNAME>.job` выполняется внутри ВМ с перепакованной ALT Rescue.
Он может использовать следующие переменные:

- `$MIRROR` - зеркало репозиториев (если подключено и только на чтение).
- `$INDIR` - путь к исходным данным из хостовой системы (только чтение).
- `$OUTDIR` - каталог для сохранения результатов и логов (полный доступ).
- `$MNTOPTS` - опции монтирования общих папок 9p для обмена данными между
  хостовой и гостевой системами.

### Задание add-ssh-keys

Это задание копирует все существующие публичные SSH-ключи, указанные в
переменной `$SSHKEYS`, на гостевую виртуальную машину и добавляет каждый
SSH-ключ суперпользователю внутри установленной гостевой ОС. После завершения
этого задания вы сможете заходить суперпользователем в гостевую ВМ без запроса
пароля.

### Задание run-ssh

Это задание также добавляет SSH-ключи, но не в установленную систему,
а в специализированную систему восстановления, после чего поднимает сеть
в этой системе восстановления, генерирует ключи хоста и запускает службу
SSH. Это позволяет немедленно выполнять дальнейшие задания через ssh, не
нужно ждать запуска виртуальной машины. Чтобы выключить виртуальную машину
в сеансе SSH, просто удалите файл `$WORKDIR/.out/RELEASE` и отключитесь.

### Задание post-install

Позволяет выполнить определённую работу после установки ОС:

- на хост-системе в вашем скрипте `post-install.pre` и ещё скопировать
  файлы в `$INDIR`;
- в гостевой системе с ALT Rescue скриптом `post-install.sh`;
- в chroot'е установленной ОС из того же скрипта;
- снова на хост-системе в вашем скрипте `post-install.post`.

Результаты выводятся в терминал хостовой системы в процессе выполнения всех
скриптов внутри ALT Rescue и записываются в журнал `$OUTDIR/job.log`. Типовое
использование подразумевает наличие лишь одного набора файлов для выполнения
этого задания в каталоге виртуальной машины (`$HOSTDIR`) со следующими
именами по умолчанию:

- `post-install.sh` - единственный обязательный файл для выполнения
  этого задания. Обратите внимание, что его имя определяется переменной
  `$SETUP_SCRIPT`, которую можно поменять через передаваемый набор параметров,
  либо переменной `$SETUP_PROFILE`, которую можно экспортировать через
  окружение при запуске команды;
- `post-install.env` (необязательный) - набор параметров, передаваемый
  всем выполняемым скриптам. Тут могут быть любые произвольные данные,
  а не только описанные далее;
- `post-install.pre` (необязательный) - выполняется на хост-системе до
  запуска основной части задания и может использоваться, например, для
  проверки возможности его выполнения;
- `post-install.post` (необязательный) - выполняется на хост-системе после
  завершения основной части задания и может использоваться, например, для
  обработки результатов задания;
- `post-install.host-$SETUP_HOSTNAME.tgz` (необязательный) - архив, обычно
  распаковываемый вашим скрпитом в корень установленной ОС. Он автоматически
  копируется в `$INDIR`, при его наличии, и если задано значение переменной
  `$SETUP_HOSTNAME`;
- `post-install.user-$SETUP_USERNAME.tgz` (необязательный) - архив,
  обычно распаковываемый вашим скрпитом в домашний каталог пользователя в
  установленной ОС. Он автоматически копируется в `$INDIR`, при его наличии.

Обратите внимание, что в каталоге `$HOSTDIR` не должно быть скрипта с именем
`post-install.job`, так как он уже находится в `$LIBEXEC/jobs` и как раз
выполняет подготовку вашего задания, в частности, он монтирует все необходимые
каталоги установленной ОС, чтобы в дальнейшем в него было проще сделать chroot.
Нет необходимости делать какие-либо файлы исполняемыми.

Задние `post-install` можно запускать многократно для одной виртуальной машины
с различающимся набором файлов и параметров. Чтобы изменить значения, принятые
по умолчанию, экспортируйте в окружение переменную `$SETUP_PROFILE`. Задние
`post-install` дополнительно определяет следующие параметры:

- `$SETUP_PROFILE` - Название профиля установки. Передаётся только через
  окружение. Все выше перечисленные файлы начинаются с этого названия. По
  умолчанию: "post-install".
- `$SETUP_VERBOSE` - Не пустое значение, если в гостевой ОС с ALT Rescue
  задание следует выполнять с отладочной информацией (`set -x`). Отладка
  также включается при наличии файла `$INDIR/DEBUG`.
- `$SETUP_ROOTDEV` - Корневой раздел установленной ОС, например, "/dev/sda3"
  или "LABEL=SYSTEM". Если не указан, используется команда `mount-system`
  для автоматического монтирования каталогов установленной ОС.
- `$SETUP_SCRIPT` - Включаемый скрипт вашего задания. По умолчанию
  определяется названием профиля с добавлением суффикса ".sh".
- `$SETUP_HOSTNAME` - Название хоста с установленной ОС, если его нужно
  поменять после установки, или для определения имени архива с файлами,
  копируемыми в корень установленной ОС.
- `$SETUP_USERNAME` - Имя пользователя в установленной ОС для манипуляции
  его профилем. По умолчанию берётся имя пользователя из хостовой ОС.
- `$SETUP_USER_UID` - UID пользователя в установленной ОС для манипуляции
  его профилем. По умолчанию берётся UID пользователя из хостовой ОС.
- `$SETUP_FILES` (массив) - Список файлов (относительно `$HOSTDIR` либо с
  абсолютными путями), которые нужно дополнительно скопировать в `$INDIR`
  до выполнения задания.
- `$DESTDIR` - Каталог с установленной ОС, например, "/mnt/system1".
  Обычно определяется и монтируется автоматически, но если нужно выполнить
  эти действия в вашем скрипте иным способом, запишите в эту переменную
  своё не пустое значение.

Можно опредилить любые другие параметры, например:

- `$SETUP_PASSWORD` - Пароль обычного пользователя, если необходимо его
  поменять после установки ОС.
- `$SETUP_ROOT_PWD` - Пароль администратора (root), если необходимо его
  поменять после установки ОС.
- `$SETUP_TIMEZONE` - Часовой пояс, если необходимо его поменять после
  установки ОС.

В скрипте вашего задания можно использовать следующие стандартные фунции:

- `fatal()` - Выводит сообщение об ошибке и аварийно завершает работу.
- `run()` - Выполняет указанное действие с записью об этом в журнал.

## Примеры использования

`vm -c 8 -m 4G @create WS10 /iso/image.iso @job prepare @run @backup`

Файлы ВМ будут созданы в текущем каталоге со следующими параметрами:
GUESTNAME=WS10, CORES=8, MEMORY=4G, BOOTIMAGE=/iso/image.iso, остальное
по умолчанию; затем задание "prepare" будет выполнено в специализированной
ВМ с ALT Rescue; затем ВМ будет единожды загружена с укзанного BOOTIMAGE;
и после выключения ВМ будет создан снимок "S0".

`vm --no-uefi --tmeout=30 @restore S2 @job add-ssh-keys`

ВМ будет восстановлена из снимка "S2"; затем в специализированной ВМ c
ALT Rescue будет выполнено задание "add-ssh-keys": оно имеет 30-секундное
ограничение по времени выполнения от момента запуска задания и ВМ ALT Rescue
будет запущена в режиме загрузки Legacy/CSM, даже если данная ВМ создавалась
с UEFI-загрузкой.

![Ещё примеры](vm.png "Типичное использование утилиты VM")

## Получение помощи

Просто запустите: `vm -h`. См. также: `alt2deploy -h`.

## Лицензия

VM распространяется под лицензией GNU General Public License (GPL) версии 3
или (по вашему желанию) любой более поздней версии.
